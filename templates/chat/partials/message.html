<div class="message-enter flex {% if message.role == 'user' %}justify-end{% else %}justify-start{% endif %} animate-fade-in"
     role="listitem"
     aria-label="{{ message.role|capfirst }} message"
     data-role="{{ message.role }}">
    <div class="max-w-3xl flex {% if message.role == 'user' %}flex-row-reverse{% else %}flex-row{% endif %} items-start space-x-3 {% if message.role == 'user' %}space-x-reverse{% endif %}">
        <!-- Enhanced Avatar -->
        <div class="flex-shrink-0">
            {% if message.role == 'user' %}
                <div class="h-10 w-10 rounded-full bg-gradient-to-br from-blue-500 via-purple-500 to-indigo-600 flex items-center justify-center shadow-lg ring-2 ring-white ring-opacity-60 transform hover:scale-105 transition-transform duration-200">
                    <svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                </div>
            {% else %}
                <div class="h-10 w-10 rounded-full bg-gradient-to-br from-emerald-400 via-teal-500 to-cyan-600 flex items-center justify-center shadow-lg ring-2 ring-white ring-opacity-60 transform hover:scale-105 transition-transform duration-200">
                    <svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                </div>
            {% endif %}
        </div>
        <!-- Enhanced Message Content -->
        <div class="flex-1 min-w-0">
            <!-- Enhanced Message Bubble -->
            <div class="relative group">
                {% if message.role == 'user' %}
                    <div class="px-5 py-4 rounded-2xl bg-gradient-to-br from-blue-500 to-indigo-600 text-white shadow-xl hover:shadow-2xl transform hover:-translate-y-0.5 transition-all duration-300 relative overflow-hidden">
                        <!-- Subtle background pattern -->
                        <div class="absolute inset-0 bg-white bg-opacity-10 bg-[radial-gradient(circle_at_50%_50%,rgba(255,255,255,0.1)_1px,transparent_1px)] bg-[length:20px_20px]"></div>
                        <!-- Message Text with Markdown Support -->
                        <div class="relative text-sm leading-relaxed break-words font-medium markdown-content">
                            {{ message.content|linebreaks }}
                        </div>
                {% else %}
                    <div class="px-5 py-4 rounded-2xl bg-gradient-to-br from-white via-gray-50 to-blue-50 border border-gray-200 text-gray-900 shadow-xl hover:shadow-2xl transform hover:-translate-y-0.5 transition-all duration-300 relative overflow-hidden">
                        <!-- Subtle background pattern -->
                        <div class="absolute inset-0 bg-gradient-to-br from-blue-50/30 via-transparent to-indigo-50/30"></div>
                        <!-- Message Text -->
                        <div class="relative text-sm leading-relaxed break-words markdown-content">
                            {{ message.content|linebreaks }}
                        </div>
                {% endif %}
                    
                        <!-- Enhanced Task Status Indicator -->
                        {% if message.task_id and message.task_status %}
                            <div class="relative mt-3 flex items-center text-xs {% if message.role == 'user' %}text-white/80{% else %}text-gray-600{% endif %} bg-black/10 backdrop-blur-sm rounded-lg px-3 py-1.5">
                                {% if message.task_status == 'PENDING' %}
                                    <svg class="animate-spin h-3 w-3 mr-2" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    Processing...
                                {% elif message.task_status == 'SUCCESS' %}
                                    <svg class="h-3 w-3 mr-2 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    Completed
                                {% elif message.task_status == 'FAILURE' %}
                                    <svg class="h-3 w-3 mr-2 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                    Failed
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                <!-- Enhanced Message timestamp -->
                <div class="absolute {% if message.role == 'user' %}right-0{% else %}left-0{% endif %} mt-2 opacity-0 group-hover:opacity-100 transition-all duration-300 transform translate-y-1 group-hover:translate-y-0">
                    <span class="text-xs text-gray-400 bg-white/80 backdrop-blur-sm px-2 py-1 rounded-md shadow-sm">
                        {{ message.created_at|date:"H:i" }}
                    </span>
                </div>
            </div>
            <!-- Artifacts Section -->
            {% if message.artifacts or message.generated_artifacts.exists %}
                <div class="mt-2 space-y-2">
                    <div class="flex items-center justify-between">
                        <h4 class="text-xs font-medium text-gray-500 uppercase tracking-wide">Generated Files</h4>
                        
                        <!-- Download All button for multiple files -->
                        {% if message.generated_artifacts.count > 1 %}
                            <button onclick="downloadAllArtifacts('{{ message.id }}')"
                                    class="inline-flex items-center px-2 py-1 bg-gray-100 hover:bg-gray-200 text-gray-700 text-xs font-medium rounded-md shadow-sm transition-colors duration-200">
                                <svg class="h-3 w-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Download All
                            </button>
                        {% endif %}
                    </div>
                    
                    {% for artifact in message.generated_artifacts.all %}
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-3 hover:from-blue-100 hover:to-indigo-100 transition-all duration-200 shadow-sm">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3 flex-1 min-w-0">
                                    <!-- Enhanced File type icon with background -->
                                    <div class="flex-shrink-0 p-2 rounded-lg bg-white shadow-sm">
                                        {% if artifact.file_type|slice:":6" == "image/" %}
                                            <svg class="h-5 w-5 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                            </svg>
                                        {% elif "excel" in artifact.file_type or "spreadsheet" in artifact.file_type %}
                                            <svg class="h-5 w-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                            </svg>
                                        {% elif "word" in artifact.file_type or "document" in artifact.file_type %}
                                            <svg class="h-5 w-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                            </svg>
                                        {% else %}
                                            <svg class="h-5 w-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                            </svg>
                                        {% endif %}
                                    </div>
                                    <!-- Enhanced File info -->
                                    <div class="flex-1 min-w-0">
                                        <p class="text-sm font-semibold text-gray-900 truncate">
                                            {{ artifact.file_name }}
                                        </p>
                                        <p class="text-xs text-gray-600">
                                            {{ artifact.file_size|filesizeformat }} • {{ artifact.created_at|timesince }} ago
                                            {% if artifact.file_type|slice:":6" == "image/" %}
                                                <span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800 ml-1">
                                                    Chart
                                                </span>
                                            {% endif %}
                                        </p>
                                    </div>
                                </div>
                                <!-- Enhanced Download button -->
                                <div class="flex-shrink-0">
                                    <a href="{% url 'chat:download_artifact' artifact.id %}"
                                       class="inline-flex items-center px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium rounded-lg shadow-sm transition-colors duration-200 focus-ring"
                                       download
                                       aria-label="Download {{ artifact.file_name }}">
                                        <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        Download
                                    </a>
                                </div>
                            </div>
                            <!-- Enhanced Image preview for charts/images -->
                            {% if artifact.file_type|slice:":6" == "image/" %}
                                <div class="mt-3 p-3 bg-white rounded-lg border border-gray-100">
                                    <div class="text-center">
                                        <img src="{% url 'chat:view_artifact_inline' artifact.id %}"
                                             alt="Generated chart: {{ artifact.file_name }}"
                                             class="max-w-full h-auto rounded-lg shadow-md mx-auto cursor-pointer"
                                             style="max-height: 400px;"
                                             loading="lazy"
                                             onclick="showFullSizeImage(this)"
                                             onerror="this.parentElement.innerHTML='<p class=\'text-gray-500 text-sm\'>Chart preview unavailable</p>'">
                                    </div>
                                    <div class="mt-2 text-center">
                                        <p class="text-xs text-gray-500">Click image to view full size or use download button above</p>
                                    </div>
                                </div>
                            {% endif %}
                            
                            <!-- Enhanced Word document preview -->
                            {% if "word" in artifact.file_type or artifact.file_name|lower|slice:"-5:" == ".docx" %}
                                {% if artifact.preview_html %}
                                    <div class="mt-3 p-3 bg-white rounded-lg border border-gray-100">
                                        <div class="flex items-center justify-between mb-3">
                                            <h4 class="text-sm font-semibold text-gray-800 flex items-center">
                                                <svg class="h-4 w-4 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                                </svg>
                                                Document Preview
                                            </h4>
                                            <div class="flex items-center space-x-2">
                                                <button onclick="toggleWordPreview('{{ artifact.id }}')"
                                                        class="inline-flex items-center px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 text-xs font-medium rounded-md transition-colors duration-200"
                                                        id="toggle-btn-{{ artifact.id }}">
                                                    <svg class="h-3 w-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                    </svg>
                                                    <span>Expand</span>
                                                </button>
                                                <button onclick="openWordPreviewWindow('{{ artifact.id }}')"
                                                        class="inline-flex items-center px-2 py-1 bg-gray-100 hover:bg-gray-200 text-gray-700 text-xs font-medium rounded-md transition-colors duration-200">
                                                    <svg class="h-3 w-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                                    </svg>
                                                    <span>Open</span>
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <!-- Preview container -->
                                        <div id="word-preview-{{ artifact.id }}"
                                             class="word-preview-container hidden overflow-hidden rounded-lg border border-gray-200"
                                             style="max-height: 400px;">
                                            <div class="relative">
                                                <!-- Loading indicator -->
                                                <div id="word-preview-loading-{{ artifact.id }}" class="absolute inset-0 bg-white bg-opacity-90 flex items-center justify-center z-10">
                                                    <div class="flex items-center space-x-2 text-gray-600">
                                                        <svg class="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24">
                                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                        </svg>
                                                        <span class="text-sm">Loading preview...</span>
                                                    </div>
                                                </div>
                                                
                                                <!-- Preview iframe -->
                                                <iframe id="word-preview-frame-{{ artifact.id }}"
                                                        src="{% url 'chat:view_word_preview' artifact.id %}"
                                                        class="w-full bg-white"
                                                        style="height: 400px; border: none;"
                                                        onload="hideWordPreviewLoading('{{ artifact.id }}')"
                                                        sandbox="allow-same-origin allow-scripts allow-popups">
                                                    <p class="p-4 text-gray-500">Your browser doesn't support iframes.
                                                       <a href="{% url 'chat:view_word_preview' artifact.id %}" target="_blank" class="text-blue-600 hover:underline">Open preview in new window</a>
                                                    </p>
                                                </iframe>
                                            </div>
                                        </div>
                                        
                                        <div class="mt-2 text-center">
                                            <p class="text-xs text-gray-500">Click "Expand" to view preview or "Open" for full window view</p>
                                        </div>
                                    </div>
                                {% endif %}
                            {% endif %}
                            
                            <!-- Enhanced Excel document preview -->
                            {% if "excel" in artifact.file_type or "spreadsheet" in artifact.file_type or artifact.file_name|lower|slice:"-5:" == ".xlsx" or artifact.file_name|lower|slice:"-4:" == ".xls" %}
                                {% if artifact.preview_html %}
                                    <div class="mt-3 p-3 bg-white rounded-lg border border-gray-100">
                                        <div class="flex items-center justify-between mb-3">
                                            <h4 class="text-sm font-semibold text-gray-800 flex items-center">
                                                <svg class="h-4 w-4 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                                </svg>
                                                Spreadsheet Preview
                                            </h4>
                                            <div class="flex items-center space-x-2">
                                                <button onclick="toggleExcelPreview('{{ artifact.id }}')"
                                                        class="inline-flex items-center px-2 py-1 bg-green-100 hover:bg-green-200 text-green-700 text-xs font-medium rounded-md transition-colors duration-200"
                                                        id="excel-toggle-btn-{{ artifact.id }}">
                                                    <svg class="h-3 w-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                    </svg>
                                                    <span>Expand</span>
                                                </button>
                                                <button onclick="openExcelPreviewWindow('{{ artifact.id }}')"
                                                        class="inline-flex items-center px-2 py-1 bg-gray-100 hover:bg-gray-200 text-gray-700 text-xs font-medium rounded-md transition-colors duration-200">
                                                    <svg class="h-3 w-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                                    </svg>
                                                    <span>Open</span>
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <!-- Preview container -->
                                        <div id="excel-preview-{{ artifact.id }}"
                                             class="excel-preview-container hidden overflow-hidden rounded-lg border border-gray-200"
                                             style="max-height: 400px;">
                                            <div class="relative">
                                                <!-- Loading indicator -->
                                                <div id="excel-preview-loading-{{ artifact.id }}" class="absolute inset-0 bg-white bg-opacity-90 flex items-center justify-center z-10">
                                                    <div class="flex items-center space-x-2 text-gray-600">
                                                        <svg class="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24">
                                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                        </svg>
                                                        <span class="text-sm">Loading spreadsheet preview...</span>
                                                    </div>
                                                </div>
                                                
                                                <!-- Preview iframe -->
                                                <iframe id="excel-preview-frame-{{ artifact.id }}"
                                                        src="{% url 'chat:view_excel_preview' artifact.id %}"
                                                        class="w-full bg-white"
                                                        style="height: 400px; border: none;"
                                                        onload="hideExcelPreviewLoading('{{ artifact.id }}')"
                                                        sandbox="allow-same-origin allow-scripts allow-popups">
                                                    <p class="p-4 text-gray-500">Your browser doesn't support iframes.
                                                       <a href="{% url 'chat:view_excel_preview' artifact.id %}" target="_blank" class="text-blue-600 hover:underline">Open preview in new window</a>
                                                    </p>
                                                </iframe>
                                            </div>
                                        </div>
                                        
                                        <div class="mt-2 text-center">
                                            <p class="text-xs text-gray-500">Click "Expand" to view preview or "Open" for full window view</p>
                                        </div>
                                    </div>
                                {% endif %}
                            {% endif %}
                        </div>
                    {% endfor %}
                    
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Screen reader announcement for new messages -->
<div class="sr-only" aria-live="polite" aria-atomic="true">
    New {{ message.role }} message: {{ message.content|truncatewords:10 }}
</div>

<script>
// Download all artifacts function
function downloadAllArtifacts(messageId) {
    // Get all download links for this message
    const messageElement = document.querySelector(`[data-message-id="${messageId}"]`) ||
                          document.querySelector(`[data-role="assistant"]:has([onclick*="${messageId}"])`);
    
    if (!messageElement) {
        // Fallback: find the message containing the clicked button
        const clickedButton = event.target.closest('button');
        const artifactsSection = clickedButton.closest('.space-y-2');
        const downloadLinks = artifactsSection.querySelectorAll('a[download]');
        
        downloadLinks.forEach((link, index) => {
            setTimeout(() => {
                link.click();
            }, index * 100); // Stagger downloads by 100ms
        });
        return;
    }
    
    const downloadLinks = messageElement.querySelectorAll('a[download][href*="download_artifact"]');
    
    if (downloadLinks.length === 0) {
        alert('No downloadable files found.');
        return;
    }
    
    // Show download progress
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = `
        <svg class="animate-spin h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Downloading...
    `;
    button.disabled = true;
    
    // Download each file with a small delay
    downloadLinks.forEach((link, index) => {
        setTimeout(() => {
            link.click();
            
            // Reset button after last download
            if (index === downloadLinks.length - 1) {
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.disabled = false;
                }, 500);
            }
        }, index * 150); // Stagger downloads by 150ms
    });
}

// Full-size image viewer function
function showFullSizeImage(img) {
    const overlay = document.createElement('div');
    overlay.className = 'fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center p-4';
    overlay.style.cursor = 'pointer';
    
    // Close on click
    overlay.onclick = () => overlay.remove();
    
    // Close on escape key
    const handleEscape = (e) => {
        if (e.key === 'Escape') {
            overlay.remove();
            document.removeEventListener('keydown', handleEscape);
        }
    };
    document.addEventListener('keydown', handleEscape);
    
    const container = document.createElement('div');
    container.className = 'relative max-w-full max-h-full';
    container.onclick = (e) => e.stopPropagation(); // Prevent closing when clicking image
    
    const fullImg = document.createElement('img');
    fullImg.src = img.src;
    fullImg.alt = img.alt;
    fullImg.className = 'max-w-full max-h-full object-contain rounded-lg shadow-2xl';
    
    // Download button in overlay
    const downloadBtn = document.createElement('a');
    downloadBtn.href = img.src.replace('/view/', '/download/');
    downloadBtn.download = '';
    downloadBtn.className = 'absolute top-4 right-4 bg-white bg-opacity-90 hover:bg-opacity-100 text-gray-800 px-3 py-2 rounded-lg shadow-lg transition-all duration-200 flex items-center space-x-2';
    downloadBtn.innerHTML = `
        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
        <span>Download</span>
    `;
    
    // Close button
    const closeBtn = document.createElement('button');
    closeBtn.className = 'absolute top-4 left-4 bg-white bg-opacity-90 hover:bg-opacity-100 text-gray-800 px-3 py-2 rounded-lg shadow-lg transition-all duration-200';
    closeBtn.innerHTML = '✕';
    closeBtn.onclick = () => overlay.remove();
    
    container.appendChild(fullImg);
    container.appendChild(downloadBtn);
    container.appendChild(closeBtn);
    overlay.appendChild(container);
    document.body.appendChild(overlay);
}

// Word Preview Functions
function toggleWordPreview(artifactId) {
    const container = document.getElementById(`word-preview-${artifactId}`);
    const button = document.getElementById(`toggle-btn-${artifactId}`);
    
    if (container.classList.contains('hidden')) {
        container.classList.remove('hidden');
        button.innerHTML = `
            <svg class="h-3 w-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
            </svg>
            <span>Collapse</span>
        `;
    } else {
        container.classList.add('hidden');
        button.innerHTML = `
            <svg class="h-3 w-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
            <span>Expand</span>
        `;
    }
}

function openWordPreviewWindow(artifactId) {
    const previewUrl = `/preview/word/${artifactId}/`;
    window.open(previewUrl, '_blank', 'width=900,height=700,scrollbars=yes,resizable=yes');
}

function hideWordPreviewLoading(artifactId) {
    const loadingDiv = document.getElementById(`word-preview-loading-${artifactId}`);
    if (loadingDiv) {
        loadingDiv.style.display = 'none';
    }
}

// Excel Preview Functions
function toggleExcelPreview(artifactId) {
    const container = document.getElementById(`excel-preview-${artifactId}`);
    const button = document.getElementById(`excel-toggle-btn-${artifactId}`);
    
    if (container.classList.contains('hidden')) {
        container.classList.remove('hidden');
        button.innerHTML = `
            <svg class="h-3 w-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
            </svg>
            <span>Collapse</span>
        `;
    } else {
        container.classList.add('hidden');
        button.innerHTML = `
            <svg class="h-3 w-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
            <span>Expand</span>
        `;
    }
}

function openExcelPreviewWindow(artifactId) {
    const previewUrl = `/preview/excel/${artifactId}/`;
    window.open(previewUrl, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
}

function hideExcelPreviewLoading(artifactId) {
    const loadingDiv = document.getElementById(`excel-preview-loading-${artifactId}`);
    if (loadingDiv) {
        loadingDiv.style.display = 'none';
    }
}

// Make images clickable for full-size view (fallback)
document.addEventListener('click', function(e) {
    if (e.target.tagName === 'IMG' && e.target.closest('.bg-white') && !e.target.hasAttribute('onclick')) {
        showFullSizeImage(e.target);
    }
});
</script>